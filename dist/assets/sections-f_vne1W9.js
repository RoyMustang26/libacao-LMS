import{B as e,C as t,F as n,H as r,M as i,N as ee,Tt as a,Xt as o,it as s,j as c,lt as te,tt as l,wt as u,yt as d,z as f}from"./vue-UmFUivib.js";import{$ as ne,H as re,Ht as ie,Nt as ae,Pt as oe,Q as se,U as ce,V as le,Vt as ue,bt as de,fn as fe,ht as pe,kt as p,nt as me,ot as he,pt as ge,rn as _e,vt as ve}from"./antd-B_p1HNUS.js";import{p as m}from"./index-BwYHa19M.js";import{t as h}from"./crud-operations-CX0bmYPf.js";var ye={style:{"margin-top":`16px`,"text-align":`right`}},be=[`onClick`],g=m(r({__name:`index`,setup(r){let m=a([]),g=a(!1),_=a(``),v=a(!1),y=a(null),b=u({section_name:``,course_id:void 0,academic_year:``,semester:`1st`,year_level:1}),x=u({current:1,total:0,pageSize:10}),S=a(!1),C=a(`schedules`),w=a(null),T=a([]),E=a(!1),D=a([]),O=a([]),k=a([]),A=a([]),j=a(``),M=a(``),N=a([]),P=a([]),F=a([]),I=a([]),L=a([]),R=a([]),z=a(``),B=a([]),V=a(!1),H=u({class_schedule_id:void 0,subject_id:void 0,professor_id:void 0,room_id:void 0,day_of_week:void 0,start_time:void 0,end_time:void 0,status:`pending`}),U=a(!1),xe=[{title:`Section`,dataIndex:`section_name`},{title:`Course`,dataIndex:`course_name`},{title:`Academic Year`,dataIndex:`academic_year`},{title:`Year Level`,dataIndex:`year_level`},{title:`Semester`,dataIndex:`semester`},{title:`Actions`,dataIndex:`actions`}];function W(e){return[{required:!0,message:`Please input ${e}`}]}function Se(){let e=j.value.toLowerCase();k.value=D.value.filter(t=>t.student.first_name.toLowerCase().includes(e)||t.student.last_name.toLowerCase().includes(e))}function Ce(){let e=M.value.toLowerCase();A.value=O.value.filter(t=>t.student.first_name.toLowerCase().includes(e)||t.student.last_name.toLowerCase().includes(e))}function we(){let e=z.value.toLowerCase();R.value=L.value.filter(t=>t.first_name.toLowerCase().includes(e)||t.last_name.toLowerCase().includes(e)||(t.student_number||``).toLowerCase().includes(e))}let G=c(()=>w.value?I.value.filter(e=>e.course_id===w.value.course_id&&e.year_level===w.value.year_level&&e.semester===w.value.semester):[]);function Te(e){B.value=e.map(e=>Number(e))}async function K(e=x.current){g.value=!0;try{let t=(await h.list(`sections`,{search:_.value,page:e,per_page:x.pageSize})).data;m.value=t.data??t,x.current=t.current_page??e,x.total=t.total??m.value.length}catch{p.error(`Error loading sections`)}finally{g.value=!1}}async function q(){try{let[e,t,n,r]=await Promise.all([h.list(`courses`),h.list(`professors`),h.list(`rooms`),h.list(`subjects`)]);N.value=(e.data?.data??e.data).map(e=>({label:`${e.course_code} - ${e.course_name}`,value:e.course_id})),P.value=(t.data?.data??t.data).map(e=>({label:`${e.first_name} ${e.last_name}`,value:e.professor_id})),F.value=(n.data?.data??n.data).map(e=>({label:`${e.room_number} - ${e.building_name}`,value:e.room_id})),I.value=(r.data?.data??r.data).map(e=>({label:`${e.subject_code} - ${e.subject_name}`,value:e.subject_id,course_id:e.course_id,year_level:e.year_level,semester:e.semester,subject_code:e.subject_code,subject_name:e.subject_name}))}catch{p.error(`Error loading support lists`)}}async function J(){if(w.value)try{L.value=(await h.list(`sections/${w.value.class_section_id}/available-students`)).data??[],R.value=[...L.value]}catch{L.value=[],R.value=[]}}function Y(e=null){y.value=e,Object.keys(b).forEach(e=>delete b[e]),e?Object.assign(b,{section_name:e.section_name,course_id:e.course_id,academic_year:e.academic_year,semester:e.semester,year_level:e.year_level}):Object.assign(b,{section_name:``,course_id:void 0,academic_year:``,semester:`1st`,year_level:1}),v.value=!0}async function Ee(){try{y.value?(await h.update(`sections`,y.value.class_section_id,b),p.success(`Section updated`)):(await h.create(`sections`,b),p.success(`Section created`)),v.value=!1,K()}catch(e){let t=e?.response?.data?.errors,n=e?.response?.data?.message||`Error saving section`;t?p.error(Object.values(t).flat().join(`
`)):p.error(n)}}async function De(e){try{await h.remove(`sections`,e.class_section_id),p.success(`Section deleted`),K()}catch(e){let t=e?.response?.data?.message||`Error deleting`;p.error(t)}}async function Oe(e){w.value=e,S.value=!0,C.value=`schedules`,await Promise.all([X(e.class_section_id),Z(e.class_section_id)])}async function X(e){try{T.value=(await h.list(`sections/${e}/schedules`)).data??[]}catch{T.value=[]}}async function Z(e){E.value=!0;try{let t=await h.list(`sections/${e}/students`);D.value=t.data.regular??[],O.value=t.data.irregular??[],k.value=[...D.value],A.value=[...O.value]}catch{D.value=[],O.value=[],k.value=[],A.value=[]}finally{E.value=!1}}function ke(e=null){Object.keys(H).forEach(e=>delete H[e]),e?Object.assign(H,e):(H.class_section_id=w.value.class_section_id,H.status=`pending`),V.value=!0}async function Ae(){try{let e={...H};H.class_schedule_id?await h.update(`schedules`,H.class_schedule_id,e):await h.create(`schedules`,e),p.success(`Schedule saved`),V.value=!1,await X(w.value.class_section_id)}catch(e){let t=e?.response?.data?.errors,n=e?.response?.data?.message||`Error saving schedule`;t?p.error(Object.values(t).flat().join(`
`)):p.error(n)}}async function je(e){try{await h.remove(`schedules`,e.class_schedule_id),p.success(`Schedule deleted`),X(w.value.class_section_id)}catch{p.error(`Error deleting schedule`)}}async function Me(){if(!w.value)return p.error(`No section selected`);if(!B.value.length)return p.error(`No students selected`);try{await Z(w.value.class_section_id);let e=D.value.length+O.value.length,t=G.value;if(!t.length){p.error(`No standard subjects found for this section (check subjects data)`);return}let n=30-e;if(n<=0){p.error(`Section is already full (max 30)`);return}if(B.value.length>n&&!await new Promise(e=>{let t=me.confirm({title:`Section Capacity`,content:`Only ${n} slot(s) available but ${B.value.length} selected. Proceed and fill up to capacity?`,okText:`Yes, fill up`,cancelText:`Cancel`,onOk(){e(!0),t.destroy()},onCancel(){e(!1),t.destroy()}})}))return;let r=0;for(let n of B.value){if(e+r>=30)break;for(let e of t)try{await h.create(`sections/${w.value.class_section_id}/assign-student`,{student_id:n,subject_id:e.value})}catch(e){let t=e?.response?.status,r=e?.response?.data?.message;if(t===409&&r&&r.toLowerCase().includes(`full`)){p.warning(`Section is full while assigning. Stopped at student ${n}.`);break}}r++}p.success(`Selected students assigned (standard subjects)`),B.value=[],await Z(w.value.class_section_id),await J(),U.value=!1}catch(e){p.error(e?.response?.data?.message||`Error assigning students`)}}async function Ne(){if(w.value)try{await h.create(`sections/${w.value.class_section_id}/auto-assign`,{}),p.success(`Students auto-assigned`),await Z(w.value.class_section_id),await J()}catch(e){p.error(e?.response?.data?.message||`Error auto-assigning`)}}async function Pe(){if(!w.value)return p.error(`No section selected`);await J(),B.value=[],U.value=!0}async function Fe(e){try{await h.remove(`assignments`,e),p.success(`Assignment removed`),w.value&&await Z(w.value.class_section_id)}catch{p.error(`Error removing assignment`)}}function Ie(e){x.current=e,K(e)}return l(()=>{K(),q()}),(r,a)=>{let c=ve,l=_e,u=ne,p=se,h=re,D=he,O=pe,L=oe,G=fe,q=ge,J=ae,X=me,Z=ce,Q=ie,Le=ue,$=le,Re=te(`a-text`),ze=de;return s(),n(`div`,null,[e(u,{style:{"margin-bottom":`16px`,width:`100%`}},{default:d(()=>[e(c,{value:_.value,"onUpdate:value":a[0]||=e=>_.value=e,placeholder:`Search sections...`,"enter-button":``,style:{"max-width":`300px`},onSearch:a[1]||=()=>{x.current=1,K()}},null,8,[`value`]),e(l,{type:`primary`,onClick:a[2]||=e=>Y()},{default:d(()=>[...a[26]||=[f(` Add Section `,-1)]]),_:1})]),_:1}),e(h,{columns:xe,"data-source":m.value,loading:g.value,"row-key":`class_section_id`,bordered:``,pagination:!1},{bodyCell:d(({column:r,record:i})=>[r.dataIndex===`actions`?(s(),ee(u,{key:0},{default:d(()=>[e(l,{type:`default`,size:`small`,onClick:e=>Y(i)},{default:d(()=>[...a[27]||=[f(`Edit`,-1)]]),_:1},8,[`onClick`]),e(l,{type:`primary`,size:`small`,onClick:e=>Oe(i)},{default:d(()=>[...a[28]||=[f(`Schedules & Students`,-1)]]),_:1},8,[`onClick`]),e(p,{title:`Delete this section?`,"ok-text":`Yes`,"cancel-text":`No`,onConfirm:e=>De(i)},{default:d(()=>[e(l,{danger:``,size:`small`},{default:d(()=>[...a[29]||=[f(`Delete`,-1)]]),_:1})]),_:1},8,[`onConfirm`])]),_:2},1024)):r.dataIndex===`course_name`?(s(),n(t,{key:1},[f(o(i.course?.course_name||`-`),1)],64)):(s(),n(t,{key:2},[f(o(i[r.dataIndex]),1)],64))]),_:1},8,[`data-source`,`loading`]),i(`div`,ye,[e(D,{current:x.current,total:x.total,"page-size":x.pageSize,"show-total":e=>`Total ${e} sections`,onChange:Ie},null,8,[`current`,`total`,`page-size`,`show-total`])]),e(X,{open:v.value,"onUpdate:open":a[8]||=e=>v.value=e,title:y.value?`Edit Section`:`Add Section`,onOk:Ee},{default:d(()=>[e(J,{model:b,layout:`vertical`},{default:d(()=>[e(L,{label:`Section Name`,name:`section_name`,rules:W(`Section Name`)},{default:d(()=>[e(O,{value:b.section_name,"onUpdate:value":a[3]||=e=>b.section_name=e},null,8,[`value`])]),_:1},8,[`rules`]),e(L,{label:`Course`,name:`course_id`,rules:W(`Course`)},{default:d(()=>[e(G,{value:b.course_id,"onUpdate:value":a[4]||=e=>b.course_id=e,options:N.value,"show-search":``,"option-filter-prop":`label`},null,8,[`value`,`options`])]),_:1},8,[`rules`]),e(L,{label:`Academic Year`,name:`academic_year`,rules:W(`Academic Year`)},{default:d(()=>[e(O,{value:b.academic_year,"onUpdate:value":a[5]||=e=>b.academic_year=e,placeholder:`e.g. 2025-2026`},null,8,[`value`])]),_:1},8,[`rules`]),e(L,{label:`Semester`,name:`semester`,rules:W(`Semester`)},{default:d(()=>[e(G,{value:b.semester,"onUpdate:value":a[6]||=e=>b.semester=e,options:[{label:`1st`,value:`1st`},{label:`2nd`,value:`2nd`},{label:`Summer`,value:`Summer`}]},null,8,[`value`])]),_:1},8,[`rules`]),e(L,{label:`Year Level`,name:`year_level`,rules:W(`Year Level`)},{default:d(()=>[e(q,{value:b.year_level,"onUpdate:value":a[7]||=e=>b.year_level=e,min:1,max:5,style:{width:`100%`}},null,8,[`value`])]),_:1},8,[`rules`])]),_:1},8,[`model`])]),_:1},8,[`open`,`title`]),e(ze,{open:S.value,"onUpdate:open":a[25]||=e=>S.value=e,title:w.value?`${w.value.section_name} (${w.value.academic_year} ${w.value.semester})`:``,width:`90%`},{default:d(()=>[e(Le,{"active-key":C.value,"onUpdate:activeKey":a[14]||=e=>C.value=e},{default:d(()=>[e(Q,{key:`schedules`,tab:`Schedules`},{default:d(()=>[e(l,{type:`primary`,style:{"margin-bottom":`12px`},onClick:a[9]||=e=>ke()},{default:d(()=>[...a[30]||=[f(`Add Schedule`,-1)]]),_:1}),e(h,{"data-source":T.value,"row-key":`class_schedule_id`,bordered:``},{default:d(()=>[e(Z,{title:`Subject`},{default:d(({record:e})=>[f(o(e.subject?.subject_code)+` - `+o(e.subject?.subject_name),1)]),_:1}),e(Z,{title:`Professor`,"data-index":`professor`},{default:d(({record:e})=>[f(o(e.professor?.first_name)+` `+o(e.professor?.last_name),1)]),_:1}),e(Z,{title:`Room`,"data-index":`room`},{default:d(({record:e})=>[f(o(e.room?.room_number)+` - `+o(e.room?.building_name),1)]),_:1}),e(Z,{title:`Day`,"data-index":`day_of_week`}),e(Z,{title:`Time`,"data-index":[`start_time`]}),e(Z,{title:`Status`,"data-index":`status`}),e(Z,{title:`Actions`,"data-index":`actions`},{default:d(({record:t})=>[e(u,null,{default:d(()=>[i(`a`,{onClick:e=>ke(t)},`Edit`,8,be),e(p,{title:`Delete schedule?`,"ok-text":`Yes`,"cancel-text":`No`,onConfirm:e=>je(t)},{default:d(()=>[...a[31]||=[i(`a`,null,`Delete`,-1)]]),_:1},8,[`onConfirm`])]),_:2},1024)]),_:1})]),_:1},8,[`data-source`])]),_:1}),e(Q,{key:`students`,tab:`Students`},{default:d(()=>[e(l,{type:`primary`,style:{"margin-bottom":`12px`},onClick:a[10]||=e=>Pe()},{default:d(()=>[...a[32]||=[f(`Assign Student(s)`,-1)]]),_:1}),e(l,{style:{"margin-left":`8px`},onClick:a[11]||=e=>Ne()},{default:d(()=>[...a[33]||=[f(`Auto Assign (backend)`,-1)]]),_:1}),e(Le,{style:{"margin-top":`12px`}},{default:d(()=>[e(Q,{key:`regular`,tab:`Regular Students`},{default:d(()=>[e(O,{value:j.value,"onUpdate:value":a[12]||=e=>j.value=e,placeholder:`Search regular students...`,style:{"margin-bottom":`10px`},onInput:Se},null,8,[`value`]),e(h,{"data-source":k.value,loading:E.value,"row-key":e=>e.student.student_id,bordered:``},{default:d(()=>[e(Z,{title:`Student No.`,"data-index":[`student`,`student_number`]}),e(Z,{title:`Name`},{default:d(({record:e})=>[f(o(e.student.first_name)+` `+o(e.student.last_name),1)]),_:1}),e(Z,{title:`Actions`},{default:d(({record:t})=>[e(p,{title:`Remove student from this section?`,"ok-text":`Yes`,"cancel-text":`No`,onConfirm:()=>Fe(t.subjects[0].id)},{default:d(()=>[...a[34]||=[i(`a`,null,`Remove`,-1)]]),_:1},8,[`onConfirm`])]),_:1})]),_:1},8,[`data-source`,`loading`,`row-key`])]),_:1}),e(Q,{key:`irregular`,tab:`Irregular Students`},{default:d(()=>[e(O,{value:M.value,"onUpdate:value":a[13]||=e=>M.value=e,placeholder:`Search irregular students...`,style:{"margin-bottom":`10px`},onInput:Ce},null,8,[`value`]),e(h,{"data-source":A.value,loading:E.value,"row-key":e=>e.student.student_id,bordered:``},{default:d(()=>[e(Z,{title:`Student No.`,"data-index":[`student`,`student_number`]}),e(Z,{title:`Name`},{default:d(({record:e})=>[f(o(e.student.first_name)+` `+o(e.student.last_name),1)]),_:1}),e(Z,{title:`Actions`},{default:d(({record:t})=>[e(p,{title:`Remove student from this section?`,"ok-text":`Yes`,"cancel-text":`No`,onConfirm:()=>Fe(t.subjects[0].id)},{default:d(()=>[...a[35]||=[i(`a`,null,`Remove`,-1)]]),_:1},8,[`onConfirm`])]),_:1})]),_:1},8,[`data-source`,`loading`,`row-key`])]),_:1})]),_:1})]),_:1})]),_:1},8,[`active-key`]),e(X,{open:V.value,"onUpdate:open":a[22]||=e=>V.value=e,title:`Schedule`,onOk:Ae},{default:d(()=>[e(J,{model:H,layout:`vertical`},{default:d(()=>[e(L,{label:`Subject`,rules:W(`Subject`)},{default:d(()=>[e(G,{value:H.subject_id,"onUpdate:value":a[15]||=e=>H.subject_id=e,options:I.value,"show-search":``,"option-filter-prop":`label`},null,8,[`value`,`options`])]),_:1},8,[`rules`]),e(L,{label:`Professor`},{default:d(()=>[e(G,{value:H.professor_id,"onUpdate:value":a[16]||=e=>H.professor_id=e,options:P.value},null,8,[`value`,`options`])]),_:1}),e(L,{label:`Room`},{default:d(()=>[e(G,{value:H.room_id,"onUpdate:value":a[17]||=e=>H.room_id=e,options:F.value},null,8,[`value`,`options`])]),_:1}),e(L,{label:`Day`},{default:d(()=>[e(G,{value:H.day_of_week,"onUpdate:value":a[18]||=e=>H.day_of_week=e,options:[{label:`Monday`,value:`Monday`},{label:`Tuesday`,value:`Tuesday`},{label:`Wednesday`,value:`Wednesday`},{label:`Thursday`,value:`Thursday`},{label:`Friday`,value:`Friday`},{label:`Saturday`,value:`Saturday`}]},null,8,[`value`])]),_:1}),e(L,{label:`Start Time`},{default:d(()=>[e($,{value:H.start_time,"onUpdate:value":a[19]||=e=>H.start_time=e,format:`HH:mm`,style:{width:`100%`}},null,8,[`value`])]),_:1}),e(L,{label:`End Time`},{default:d(()=>[e($,{value:H.end_time,"onUpdate:value":a[20]||=e=>H.end_time=e,format:`HH:mm`,style:{width:`100%`}},null,8,[`value`])]),_:1}),e(L,{label:`Status`},{default:d(()=>[e(G,{value:H.status,"onUpdate:value":a[21]||=e=>H.status=e,options:[{label:`Pending`,value:`pending`},{label:`Finalized`,value:`finalized`}]},null,8,[`value`])]),_:1})]),_:1},8,[`model`])]),_:1},8,[`open`]),e(X,{open:U.value,"onUpdate:open":a[24]||=e=>U.value=e,title:`Assign Students to Section`,onOk:Me,width:`600px`},{default:d(()=>[e(u,{direction:`vertical`,style:{width:`100%`}},{default:d(()=>[e(O,{value:z.value,"onUpdate:value":a[23]||=e=>z.value=e,placeholder:`Search student...`,onInput:we},null,8,[`value`]),e(h,{"data-source":R.value,"row-selection":{selectedRowKeys:B.value,onChange:Te},"row-key":e=>e.student_id,pagination:!1,bordered:``,size:`small`},{default:d(()=>[e(Z,{title:`Student Number`,"data-index":`student_number`}),e(Z,{title:`Name`},{default:d(({record:e})=>[f(o(e.first_name)+` `+o(e.last_name),1)]),_:1})]),_:1},8,[`data-source`,`row-selection`,`row-key`]),i(`div`,null,[e(Re,null,{default:d(()=>[...a[36]||=[f(`Note: Assigning will enroll each selected student in `,-1),i(`strong`,null,`all standard subjects`,-1),f(` for the section (based on course, year level, semester).`,-1)]]),_:1})]),e(l,{type:`primary`,style:{"margin-top":`10px`},onClick:Ne},{default:d(()=>[...a[37]||=[f(`Auto Assign (backend)`,-1)]]),_:1})]),_:1})]),_:1},8,[`open`])]),_:1},8,[`open`,`title`])])}}}),[[`__scopeId`,`data-v-63c3250f`]]);export{g as default};